<link rel="stylesheet" href="{{ static('css/matching.css') }}">

<form id="assignmentMovedForm"
      hx-patch="/matching/move/"
      hx-ext="json-enc"
      hx-headers='{"X-CSRFToken": "{{ get_csrf_token(request) }}"}'
      hx-target="#errorContainer"
      hx-trigger="assignmentmoved"
      hx-swap="outerHTML"
      hx-target="#kanban-board"
      class="">
    <input type="hidden" name="assignmentId" value="">
    <input type="hidden" name="statusId" value="">
</form>
<div id="errorContainer"></div>

<div class="wies-kanban-board" id="kanban-board">
    <!-- LEAD opdrachten -->
    <div class="wies-kanban-column" data-column="LEAD">
        <div class="wies-kanban-column-header">
            <div class="wies-kanban-column-title">
                <span class="utrecht-icon rvo-icon rvo-icon-pijl-naar-rechts rvo-icon--lg" role="img" aria-label="lead-icon"></span>
                <span>Lead</span>
            </div>
            <span class="rvo-badge">{{ assignments_by_status.LEAD|length }}</span>
        </div>
        <div class="wies-kanban-cards" id="lead-cards">
            {% for assignment in assignments_by_status.LEAD %}
            <div class="wies-kanban-card" draggable="true" data-type="assignment" data-id="{{ assignment.id }}" onclick="openAssignment({{ assignment.id }})">
                <div class="wies-card-title">{{ assignment.name }}</div>
                <div class="wies-card-subtitle">{{ assignment.ministry.name }}</div>
                <div class="wies-card-meta">
                    {% if assignment.start_date %}{{ assignment.start_date.strftime('%d %b %Y') }}{% endif %}
                    {% if assignment.end_date %} - {{ assignment.end_date.strftime('%d %b %Y') }}{% endif %}
                </div>
            </div>
            {% else %}
            <div class="rvo-text rvo-text--subtle">Geen lead opdrachten</div>
            {% endfor %}
        </div>
    </div>

    <!-- VACATURE opdrachten -->
    <div class="wies-kanban-column" data-column="VACATURE">
        <div class="wies-kanban-column-header">
            <div class="wies-kanban-column-title">
                <span class="utrecht-icon rvo-icon rvo-icon-refresh rvo-icon--lg" role="img" aria-label="vacature-icon"></span>
                <span>Vacature</span>
            </div>
            <span class="rvo-badge">{{ assignments_by_status.VACATURE|length }}</span>
        </div>
        <div class="wies-kanban-cards" id="vacature-cards">
            {% for assignment in assignments_by_status.VACATURE %}
            <div class="wies-kanban-card" draggable="true" data-type="assignment" data-id="{{ assignment.id }}" onclick="openAssignment({{ assignment.id }})">
                <div class="wies-card-title">{{ assignment.name }}</div>
                <div class="wies-card-subtitle">{{ assignment.ministry.name }}</div>
                <div class="wies-card-meta">
                    {% if assignment.start_date %}{{ assignment.start_date.strftime('%d %b %Y') }}{% endif %}
                    {% if assignment.end_date %} - {{ assignment.end_date.strftime('%d %b %Y') }}{% endif %}
                </div>
            </div>
            {% else %}
            <div class="rvo-text rvo-text--subtle">Geen vacature opdrachten</div>
            {% endfor %}
        </div>
    </div>

    <!-- INGEVULD opdrachten -->
    <div class="wies-kanban-column" data-column="INGEVULD">
        <div class="wies-kanban-column-header">
            <div class="wies-kanban-column-title">
                <span class="utrecht-icon rvo-icon rvo-icon-vinkje rvo-icon--lg" role="img" aria-label="ingevuld-icon"></span>
                <span>Ingevuld</span>
            </div>
            <span class="rvo-badge">{{ assignments_by_status.INGEVULD|length }}</span>
        </div>
        <div class="wies-kanban-cards" id="ingevuld-cards">
            {% for assignment in assignments_by_status.INGEVULD %}
            <div class="wies-kanban-card" draggable="true" data-type="assignment" data-id="{{ assignment.id }}" onclick="openAssignment({{ assignment.id }})">
                <div class="wies-card-title">{{ assignment.name }}</div>
                <div class="wies-card-subtitle">{{ assignment.ministry.name }}</div>
                <div class="wies-card-meta">
                    {% if assignment.start_date %}{{ assignment.start_date.strftime('%d %b %Y') }}{% endif %}
                    {% if assignment.end_date %} - {{ assignment.end_date.strftime('%d %b %Y') }}{% endif %}
                </div>
            </div>
            {% else %}
            <div class="rvo-text rvo-text--subtle">Geen ingevulde opdrachten</div>
            {% endfor %}
        </div>
    </div>

    <!-- AFGEWEZEN opdrachten -->
    <div class="wies-kanban-column" data-column="AFGEWEZEN">
        <div class="wies-kanban-column-header">
            <div class="wies-kanban-column-title">
                <span class="utrecht-icon rvo-icon rvo-icon-kruis rvo-icon--lg" role="img" aria-label="afgewezen-icon"></span>
                <span>Afgewezen</span>
            </div>
            <span class="rvo-badge">{{ assignments_by_status.AFGEWEZEN|length }}</span>
        </div>
        <div class="wies-kanban-cards" id="afgewezen-cards">
            {% for assignment in assignments_by_status.AFGEWEZEN %}
            <div class="wies-kanban-card" draggable="true" data-type="assignment" data-id="{{ assignment.id }}" onclick="openAssignment({{ assignment.id }})">
                <div class="wies-card-title">{{ assignment.name }}</div>
                <div class="wies-card-subtitle">{{ assignment.ministry.name }}</div>
                <div class="wies-card-meta">
                    {% if assignment.start_date %}{{ assignment.start_date.strftime('%d %b %Y') }}{% endif %}
                    {% if assignment.end_date %} - {{ assignment.end_date.strftime('%d %b %Y') }}{% endif %}
                </div>
            </div>
            {% else %}
            <div class="rvo-text rvo-text--subtle">Geen afgewezen opdrachten</div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedElement = null;
    let draggedData = null;

    // Maak alle cards draggable
    document.querySelectorAll('.wies-kanban-card[draggable="true"]').forEach(card => {
        card.addEventListener('dragstart', function(e) {
            draggedElement = this;
            draggedData = {
                type: this.dataset.type,
                id: this.dataset.id
            };
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            draggedElement = null;
            draggedData = null;
            
            // Verwijder drag-over class van alle kolommen
            document.querySelectorAll('.wies-kanban-column').forEach(col => {
                col.classList.remove('drag-over');
            });
        });
    });

    // Maak kolommen droppable
    document.querySelectorAll('.wies-kanban-column').forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });

        column.addEventListener('dragleave', function(e) {
            // Check of we echt de kolom verlaten (niet alleen een child element)
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        });

        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (!draggedElement || !draggedData) return;

            const targetColumn = this.dataset.column;
            const cardsContainer = this.querySelector('.wies-kanban-cards');
            
            // Bepaal welke acties toegestaan zijn
            const sourceColumn = draggedElement.closest('.wies-kanban-column').dataset.column;
            
            if (sourceColumn === targetColumn) {
                return; // Geen actie nodig
            }

            // Update de status van de opdracht
            handleStatusChange(draggedData, targetColumn);
            
            // Verplaats de kaart visueel
            cardsContainer.appendChild(draggedElement);
            
            // Update de counter
            updateColumnCounts();
            
            // Trigger HTMX event voor backend update
            document.querySelector('input[name="assignmentId"]').value = draggedData.id;
            document.querySelector('input[name="statusId"]').value = targetColumn;
            htmx.trigger('#assignmentMovedForm', 'assignmentmoved');
        });
    });

    function handleStatusChange(draggedData, targetColumn) {
        console.log('Status wijzigen van opdracht:', draggedData.id, 'naar:', targetColumn);
    }

    function updateColumnCounts() {
        document.querySelectorAll('.wies-kanban-column').forEach(column => {
            const count = column.querySelectorAll('.wies-kanban-card').length;
            const countElement = column.querySelector('.rvo-badge');
            countElement.textContent = count;
        });
    }
    
    // Open assignment detail page
    window.openAssignment = function(assignmentId) {
        window.location.href = '/assignments/' + assignmentId + '/';
    }
    
});
</script>