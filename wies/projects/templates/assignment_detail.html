{% extends "base.html" %}

{% block content %}
<div class="rvo-layout-column rvo-layout-gap--xl">
  <div>
        <!-- Breadcrumbs -->
        <ol class="rvo-breadcrumbs rvo-breadcrumbs--sm">
          <li class="rvo-breadcrumbs-item">
            <a href="/assignments/" class="rvo-link rvo-link--no-underline">Opdrachten</a>
          </li>
          <li class="rvo-breadcrumbs-item">
            <span class="utrecht-icon rvo-icon rvo-icon-delta-naar-rechts rvo-icon--xs rvo-icon--hemelblauw" role="img" aria-label="Delta naar rechts"></span>
            <span class="rvo-breadcrumb-current-page">{{ object.name }}</span>
          </li>
        </ol>
    <h1 class="utrecht-heading-1 rvo-heading--no-margins">{{ object.name }}</h1>
  </div>
  
  <!-- Statistics Cards -->
  <div class="rvo-max-width-layout rvo-max-width-layout--md rvo-layout-margin-bottom--sm">
    <div class="rvo-layout-grid rvo-layout-gap--md rvo-layout-grid-columns--three">
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-kalender rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Weken tot eind opdracht"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Weken tot eind opdracht</h4>
          {% if weeks_remaining is not None %}
            {% if weeks_remaining > 0 %}
              {{ weeks_remaining }} weken
            {% else %}
              Afgelopen
            {% endif %}
          {% else %}
            Geen einddatum
          {% endif %}
        </div>
      </div>
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-map-vol-documenten rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Budget besteed"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Budget besteed</h4>
          {{ budget_percentage }}%
        </div>
      </div>
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-kalender-met-vinkje rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Kalender met vinkje"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Opdracht score</h4>
          {{ project_score }}
        </div>
      </div>
    </div>
  </div>
  
  <div class="rvo-layout-column rvo-layout-gap--lg">
    <h2 class="utrecht-heading-2 rvo-heading--no-margins">Opdracht gegevens</h2>
    
    <dl class="rvo-data-list">
      <dt>Opdracht naam</dt>
      <dd>{{ object.name }}</dd>
      <dt>Opdrachtgever</dt>
      <dd><a href="/clients/{{ object.organization }}">{{ object.organization }}</a></dd>
      <dt>Ministerie</dt>
      <dd>
        {% if object.ministry %}
          <a href="{% url 'ministry-detail' object.ministry.pk %}" class="rvo-link">{{ object.ministry.name }} ({{ object.ministry.abbreviation }})</a>
        {% else %}
          <span class="rvo-text--italic">Geen ministerie opgegeven</span>
        {% endif %}
      </dd>
      <dt>Status</dt>
      <dd>
        <span class="rvo-tag status-{{ object.status|lower }}">{{ object.status }}</span>
      </dd>
      <dt>Startdatum</dt>
      <dd>{{ object.start_date }}</dd>
      <dt>Einddatum</dt>
      <dd>{{ object.end_date }}</dd>
      <dt>Extra info</dt>
      <dd>{{ object.extra_info }}</dd>
    </dl>

    <div class="rvo-layout-row rvo-layout-gap--md">
      <a href="/assignments/{{ object.pk }}/update" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-md rvo-link--no-underline">
        Opdracht bewerken
      </a>
      <a href="/assignments/{{ object.pk }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-md">
        Opdracht verwijderen
      </a>
    </div>

    <!-- Tab Navigation -->
    <div class="assignment-tabs-navigation" style="margin-top: 2rem; margin-bottom: 1rem;">
      <ul
        class="rvo-tabs rvo-ul rvo-ul--no-margin rvo-ul--no-padding rvo-ul--icon rvo-ul--icon-option-2"
        role="tablist"
        aria-label="Assignment Detail Tabs"
      >
        {% for tab_key, tab_data in tab_groups.items %}
        <li role="presentation" class="rvo-tabs__item">
          <a
            href="?tab={{ tab_key }}"
            class="rvo-link rvo-tabs__item-link {% if active_tab == tab_key %}rvo-tabs__item-link--active rvo-link--active{% endif %} rvo-link--no-underline"
            role="tab"
            aria-selected="{% if active_tab == tab_key %}true{% else %}false{% endif %}"
          >
            {{ tab_data.title }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Tab Content -->
    {% if active_tab == 'services' %}
    <div id="tab-diensten">
      <h2 class="utrecht-heading-2 rvo-heading--no-margins">Diensten</h2>

    <div class="rvo-table--responsive">
      <table class="rvo-table">
        <thead class="rvo-table-head">
          <tr class="rvo-table-row">
            <th class="rvo-table-header">Omschrijving</th>
            <th class="rvo-table-header">Rol</th>
            <th class="rvo-table-header">Start datum</th>
            <th class="rvo-table-header">Eind datum</th>
            <th class="rvo-table-header">Kosten</th>
            <th class="rvo-table-header">Acties</th>
          </tr>
        </thead>
        <tbody class="rvo-table-body">
          {% for service in object.services.all %}
          <tr class="rvo-table-row">
            <td class="rvo-table-cell">{{ service.description }}</td>
            <td class="rvo-table-cell">
              {% if service.skill %}
                 <span class="rvo-tag">{{ service.skill.name }}</span>
              {% else %}
                <span class="rvo-text--italic">Geen rol opgegeven</span>
              {% endif %}
            </td>
            <td class="rvo-table-cell">{{ service.start_date}}</td>
            <td class="rvo-table-cell">{{ service.end_date }}</td>
            <td class="rvo-table-cell">
              {% if service.cost_type == "FIXED_PRICE" %}
                €{{ service.fixed_cost|format_currency }}
              {% elif service.cost_type == "PER_HOUR" %}
                {% with total_cost=service.get_total_cost weeks=service.get_weeks %}
                  {% if total_cost %}
                    €{{ total_cost|format_currency }}
                    <br>
                    <small style="color: #666; font-size: 0.8em;">
                      {{ weeks }} weken × {{ service.hours_per_week }} uur × €100
                    </small>
                  {% else %}
                    <span class="rvo-text--italic">Niet beschikbaar</span>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            <td class="rvo-table-cell">
              <a href="/services/{{ service.id }}/update" class="rvo-link">edit</a> / 
              <a href="/services/{{ service.id }}/delete" class="rvo-link">delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

<a href="/assignments/{{ object.pk }}/services/new" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-md rvo-link--no-underline">
        Dienst toevoegen
      </a>

    <h2 class="utrecht-heading-2 rvo-heading--no-margins">Inzet</h2>

    <div class="rvo-table--responsive">
      <table class="rvo-table">
        <thead class="rvo-table-head">
          <tr class="rvo-table-row">
            <th class="rvo-table-header">Dienst</th>
            <th class="rvo-table-header">Rol</th>
            <th class="rvo-table-header">Collega</th>
            <th class="rvo-table-header">Start datum</th>
            <th class="rvo-table-header">Eind datum</th>
            <th class="rvo-table-header">Uren per week</th>
            <th class="rvo-table-header">Acties</th>
          </tr>
        </thead>
        <tbody class="rvo-table-body">
          {% for service in object.services.all %}
            {% for placement in service.placements.all %}
            <tr class="rvo-table-row">
              <td class="rvo-table-cell">{{ service.description }}</td>
              <td class="rvo-table-cell">
                {% if service.skill %}
                  <span class="rvo-tag">{{ service.skill.name }}</span>
                {% else %}
                  <span class="rvo-text--italic">Geen rol opgegeven</span>
                {% endif %}
              </td>
              {% if placement.colleague %}
                <td class="rvo-table-cell"><a href="{% url 'colleague-detail' placement.colleague.pk %}" class="rvo-link">{{ placement.colleague.name }}</a></td>
              {% else %}
                <td class="rvo-table-cell"></td>
              {% endif %}
              <td class="rvo-table-cell">{{ placement.start_date }}</td>
              <td class="rvo-table-cell">{{ placement.end_date }}</td>
              <td class="rvo-table-cell">{{ placement.hours_per_week }}</td>
              <td class="rvo-table-cell">
                <a href="/placements/{{ placement.id }}/update" class="rvo-link">edit</a> / 
                <a href="/placements/{{ placement.id }}/delete" class="rvo-link">delete</a>
              </td>
            </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>

<a href="/assignments/{{ object.pk }}/placements/new" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-md rvo-link--no-underline">
        Inzet toevoegen
      </a>
    </div>
    {% endif %}

    {% if active_tab == 'notes' %}
    <div id="tab-notities">
      <h2 class="utrecht-heading-2 rvo-heading--no-margins">Notities</h2>

    {% if notes %}
      <div class="rvo-layout-column rvo-layout-gap--md">
        {% for note in notes %}
          <div class="rvo-card rvo-card--outline rvo-card--padding-md">
            <div class="rvo-card__content">
              <div class="rvo-layout-row rvo-layout-gap--sm">
                <strong>{{ note.colleague.name }}</strong>
                <span class="rvo-text--subtle">{{ note.created_at|date:"d-m-Y H:i" }}</span>
              </div>
              <p class="rvo-paragraph">{{ note.message }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="rvo-text--italic">Nog geen notities toegevoegd.</p>
    {% endif %}

    <div class="rvo-layout-row rvo-layout-gap--md">
      <button type="button" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-md" onclick="toggleNoteForm()">
        Notitie toevoegen
      </button>
    </div>

    <!-- Note form (initially hidden) -->
    <div id="note-form" class="rvo-layout-column rvo-layout-gap--md" style="display: none; margin-top: 1rem;">
      <form method="post" action="{% url 'add-note' object.pk %}">
        {% csrf_token %}
        <div class="rvo-form-field">
          <label for="note-message" class="rvo-label">Notitie:</label>
          <textarea id="note-message" name="message" class="rvo-textarea" rows="4" placeholder="Voer uw notitie in..." required></textarea>
        </div>
        <div class="rvo-layout-row rvo-layout-gap--sm">
          <button type="submit" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-sm">
            Notitie opslaan
          </button>
          <button type="button" class="utrecht-button utrecht-button--subtle utrecht-button--rvo-sm" onclick="toggleNoteForm()">
            Annuleren
          </button>
        </div>
      </form>
    </div>

    <script>
      function toggleNoteForm() {
        const form = document.getElementById('note-form');
        const isHidden = form.style.display === 'none';
        form.style.display = isHidden ? 'block' : 'none';
        
        if (isHidden) {
          // Clear the form when showing
          document.getElementById('note-message').value = '';
        }
      }
    </script>
    </div>
    {% endif %}

  </div>
</div>
{% endblock content %}