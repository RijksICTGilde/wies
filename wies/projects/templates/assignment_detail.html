{% extends "base.html" %}

{% block content %}
<div class="rvo-layout-column rvo-layout-gap--xl">
  <div>
        <!-- Breadcrumbs -->
        <ol class="rvo-breadcrumbs rvo-breadcrumbs--sm">
          <li class="rvo-breadcrumbs-item">
            <a href="/assignments/" class="rvo-link rvo-link--no-underline">Opdrachten</a>
          </li>
          <li class="rvo-breadcrumbs-item">
            <span class="utrecht-icon rvo-icon rvo-icon-delta-naar-rechts rvo-icon--xs rvo-icon--hemelblauw" role="img" aria-label="Delta naar rechts"></span>
            <span class="rvo-breadcrumb-current-page">{{ object.name }}</span>
          </li>
        </ol>
    <h1 class="utrecht-heading-1 rvo-heading--no-margins">{{ object.name }}</h1>
  </div>

  <!-- Assignment Information Cards -->
  <div class="rvo-card rvo-card--outline rvo-card--padding-lg rvo-layout-margin-bottom--xl rvo-card--full-colour--grijs-100">
    <div class="rvo-layout-grid rvo-layout-gap--lg rvo-layout-grid-columns--three">
      
      <!-- Periode -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-kalender rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Kalender"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Periode:</h4>
        </div>
        <p class="utrecht-paragraph rvo-paragraph--no-margins">
          {{ object.start_date|date:"j M Y" }} - {{ object.end_date|date:"j M Y" }}
        </p>
      </div>

      <!-- Status -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-vinkje rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Status"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Status:</h4>
        </div>
        <p class="utrecht-paragraph rvo-paragraph--no-margins">
          <span class="rvo-tag rvo-tag--warning">{{ object.status }}</span>
        </p>
      </div>

      <!-- Opdrachtgever -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-gebruiker rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Opdrachtgever"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Opdrachtgever:</h4>
        </div>
        <p class="utrecht-paragraph rvo-paragraph--no-margins">
          {% if object.organization %}
            {{ object.organization }}
          {% else %}
            <span class="rvo-text--italic">Geen opdrachtgever opgegeven</span>
          {% endif %}
        </p>
      </div>

      <!-- Ministerie -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-informatie rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Ministerie"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Ministerie:</h4>
        </div>
        <p class="utrecht-paragraph rvo-paragraph--no-margins">
          {% if object.ministry %}
            {{ object.ministry.name }}
          {% else %}
            <span class="rvo-text--italic">Geen ministerie opgegeven</span>
          {% endif %}
        </p>
      </div>

      <!-- Omschrijving -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-document-tekst rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Omschrijving"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Omschrijving:</h4>
        </div>
        <p class="utrecht-paragraph rvo-paragraph--no-margins">
          {% if object.extra_info %}
            {{ object.extra_info }}
          {% else %}
            <span class="rvo-text--italic">Geen omschrijving opgegeven</span>
          {% endif %}
        </p>
      </div>

      <!-- Acties -->
      <div class="rvo-layout-column">
        <div class="rvo-layout-row rvo-layout-gap--sm rvo-layout-align--center rvo-layout-margin-bottom--md">
          <span class="utrecht-icon rvo-icon rvo-icon-instellingen rvo-icon--md rvo-icon--hemelblauw" role="img" aria-label="Acties"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Acties:</h4>
        </div>
        <div class="rvo-layout-column rvo-layout-gap--xs">
          <button class="utrecht-button utrecht-button--rvo-tertiary-action utrecht-button--rvo-md" type="button" onclick="window.location.href='/assignments/{{ object.pk }}/update'">
            <span class="utrecht-icon rvo-icon rvo-icon-bewerken rvo-icon--sm rvo-icon--hemelblauw" role="img" aria-label="Bewerken"></span>
            Bewerken
          </button>
          <button class="utrecht-button utrecht-button--rvo-tertiary-action utrecht-button--warning utrecht-button--rvo-md" type="button" onclick="window.location.href='/assignments/{{ object.pk }}/delete'">
            <span class="utrecht-icon rvo-icon rvo-icon-verwijderen rvo-icon--sm" role="img" aria-label="Verwijderen"></span>
            Verwijderen
          </button>
        </div>
      </div>
      
    </div>
  </div>



  <div class="rvo-layout-row rvo-layout-gap--md rvo-layout-align--space-between rvo-layout-align--center">
    <h2 class="utrecht-heading-2 rvo-heading--no-margins">Diensten</h2>
    <a href="/assignments/{{ object.pk }}/services/new" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-sm rvo-link--no-underline">
      <span class="utrecht-icon rvo-icon rvo-icon-plus rvo-icon--sm rvo-icon--wit" role="img" aria-label="Toevoegen"></span>
      Dienst toevoegen
    </a>
  </div>

    {% for service in object.services.all %}
    <div class="rvo-card rvo-card--outline rvo-card--padding-lg rvo-layout-margin-bottom--lg">
      <!-- Service Header -->
      <div class="rvo-layout-row rvo-layout-gap--md rvo-layout-align--space-between rvo-layout-align--center rvo-layout-margin-bottom--lg">
        <h3 class="utrecht-heading-3 rvo-heading--no-margins">{{ service.description }}</h3>
        <div class="rvo-layout-row rvo-layout-gap--sm">
          <a href="/services/{{ service.id }}/update" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-sm rvo-link--no-underline">
            Bewerken
          </a>
          <a href="/services/{{ service.id }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-sm rvo-link--no-underline">
            Verwijderen
          </a>
        </div>
      </div>

      <!-- Details Grid -->
      <div class="rvo-layout-grid rvo-layout-gap--lg rvo-layout-grid-columns--four rvo-layout-margin-bottom--lg">
        {% if service.skill %}
          <!-- Search Criteria -->
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Profiel:</h4>
            <span class="rvo-tag">{{ service.skill.name }}</span>
          </div>
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Wanneer:</h4>
            <p class="utrecht-paragraph rvo-paragraph--no-margins">
              {{ service.start_date|date:"j M Y" }} - {{ service.end_date|date:"j M Y" }}
            </p>
          </div>
          
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Status:</h4>
            {% if service.placements.count == 0 %}
              <span class="rvo-tag rvo-tag--warning">Open</span>
            {% else %}
              <span class="rvo-tag rvo-tag--success">Matched</span>
            {% endif %}
          </div>
        {% else %}
          <!-- Cost Item Details -->
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Type kostenpost:</h4>
            <span class="rvo-tag rvo-tag--secondary">Service/Middel</span>
          </div>
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Periode:</h4>
            <p class="utrecht-paragraph rvo-paragraph--no-margins">
              {{ service.start_date|date:"j M Y" }} - {{ service.end_date|date:"j M Y" }}
            </p>
          </div>
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Budget:</h4>
            <p class="utrecht-paragraph rvo-paragraph--no-margins">
              {% if service.cost_type == "FIXED_PRICE" %}
                €{{ service.fixed_cost|floatformat:2 }}
                <br>
                <small class="rvo-text--subtle">Vaste kosten</small>
              {% elif service.cost_type == "PER_HOUR" %}
                {% with total_cost=service.get_total_cost weeks=service.get_weeks %}
                  {% if total_cost %}
                    €{{ total_cost|floatformat:2 }}
                    <br>
                    <small class="rvo-text--subtle">
                      Geschatte kosten
                    </small>
                  {% else %}
                    <span class="rvo-text--italic">Budget nog te bepalen</span>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </p>
          </div>
          <div class="rvo-layout-column">
            <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Status:</h4>
            <span class="rvo-tag rvo-tag--info">Goedgekeurd</span>
          </div>
        {% endif %}
      </div>

      <!-- Found Matches (only for people searches) -->
      {% if service.skill %}
        <div class="rvo-layout-margin-bottom--md">
          <h4 class="utrecht-heading-4 rvo-heading--no-margins rvo-layout-margin-bottom--md">Matches:</h4>
          
          {% if not service.placements.all %}
            <!-- Show potential matches when no one is assigned yet -->
            {% comment %}TODO: Replace with actual available colleague count with matching skill{% endcomment %}
            {% with potential_matches=5 %}
              <div class="rvo-card rvo-card--outline rvo-card--padding-sm rvo-layout-margin-bottom--md">
                <p class="utrecht-paragraph rvo-paragraph--no-margins">
                  <span class="utrecht-icon rvo-icon rvo-icon-gebruiker rvo-icon--xs rvo-icon--hemelblauw" role="img" aria-label="Mogelijke matches"></span>
                  {{ potential_matches }} {% if potential_matches == 1 %}mogelijke match{% else %}mogelijke matches{% endif %} beschikbaar
                </p>
              </div>
            {% endwith %}
          {% else %}
            <!-- Show assigned people -->
          {% for placement in service.placements.all %}
          <div class="rvo-card rvo-card--outline rvo-card--padding-sm rvo-layout-margin-bottom--md rvo-card--full-colour--grijs-100">
            <div class="rvo-layout-grid rvo-layout-gap--md rvo-layout-grid-columns--four">
              <div class="rvo-layout-column">
                <h5 class="utrecht-heading-5 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Persoon:</h5>
                {% if placement.colleague %}
                  <a href="{% url 'colleague-detail' placement.colleague.pk %}" class="rvo-link">{{ placement.colleague.name }}</a>
                {% else %}
                  <span class="rvo-text--italic">TBD</span>
                {% endif %}
              </div>
              <div class="rvo-layout-column">
                <h5 class="utrecht-heading-5 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Beschikbaar:</h5>
                <span>{{ placement.start_date|date:"j M Y" }} - {{ placement.end_date|date:"j M Y" }}</span>
              </div>
              <div class="rvo-layout-column">
                <h5 class="utrecht-heading-5 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Inzet:</h5>
                <span>{{ placement.hours_per_week }}u/week</span>
              </div>
              <div class="rvo-layout-column">
                <h5 class="utrecht-heading-5 rvo-heading--no-margins rvo-layout-margin-bottom--xs">Acties:</h5>
                <div class="rvo-layout-row rvo-layout-gap--sm">
                  <a href="/placements/{{ placement.id }}/update" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-xs rvo-link--no-underline">
                    Wijzig
                  </a>
                  <a href="/placements/{{ placement.id }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-xs rvo-link--no-underline">
                    Remove
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
          {% endif %}
        </div>

        <!-- Add match button (only for people searches) -->
        <div>
          <a href="/assignments/{{ object.pk }}/placements/new?service={{ service.id }}" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-sm rvo-link--no-underline">
            Bekijk matches
          </a>
        </div>
      {% endif %}
    </div>
    {% empty %}
    <div class="rvo-card rvo-card--outline rvo-card--padding-lg">
      <p class="utrecht-paragraph rvo-paragraph--no-margins rvo-text--subtle">
        Nog geen diensten gedefinieerd voor deze opdracht.
      </p>
    </div>
    {% endfor %}

  </div>
</div>
{% endblock content %}