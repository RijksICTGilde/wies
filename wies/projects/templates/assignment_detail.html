{% extends "base.html" %}

{% block content %}
<div class="rvo-layout-column rvo-layout-gap--xl">
  <div>
        <!-- Breadcrumbs -->
        <ol class="rvo-breadcrumbs rvo-breadcrumbs--sm">
          <li class="rvo-breadcrumbs-item">
            <a href="/assignments/" class="rvo-link rvo-link--no-underline">Opdrachten</a>
          </li>
          <li class="rvo-breadcrumbs-item">
            <span class="utrecht-icon rvo-icon rvo-icon-delta-naar-rechts rvo-icon--xs rvo-icon--hemelblauw" role="img" aria-label="Delta naar rechts"></span>
            <span class="rvo-breadcrumb-current-page">{{ object.name }}</span>
          </li>
        </ol>
    <h1 class="utrecht-heading-1 rvo-heading--no-margins">{{ object.name }}</h1>
  </div>
  
  <!-- Statistics Cards -->
  <div class="rvo-max-width-layout rvo-max-width-layout--md rvo-layout-margin-bottom--sm">
    <div class="rvo-layout-grid rvo-layout-gap--md rvo-layout-grid-columns--three">
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-kalender rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Weken tot eind opdracht"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Weken tot eind opdracht</h4>
          {% if weeks_remaining is not None %}
            {% if weeks_remaining > 0 %}
              {{ weeks_remaining }} weken
            {% else %}
              Afgelopen
            {% endif %}
          {% else %}
            Geen einddatum
          {% endif %}
        </div>
      </div>
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-map-vol-documenten rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Budget besteed"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Budget besteed</h4>
          {{ budget_percentage }}%
        </div>
      </div>
      <div class="rvo-card rvo-card--outline rvo-card--padding-md">
        <div class="rvo-card__content">
          <span class="utrecht-icon rvo-icon rvo-icon-kalender-met-vinkje rvo-icon--2xl rvo-icon--hemelblauw" role="img" aria-label="Kalender met vinkje"></span>
          <h4 class="utrecht-heading-4 rvo-heading--no-margins">Opdracht score</h4>
          {{ project_score }}
        </div>
      </div>
    </div>
  </div>
  
  <div class="rvo-layout-column rvo-layout-gap--lg">
    <h2 class="utrecht-heading-2 rvo-heading--no-margins">Opdracht gegevens</h2>
    
    <dl class="rvo-data-list">
      <dt>Opdracht naam</dt>
      <dd>{{ object.name }}</dd>
      <dt>Opdrachtgever</dt>
      <dd><a href="/clients/{{ object.organization }}">{{ object.organization }}</a></dd>
      <dt>Ministerie</dt>
      <dd>
        {% if object.ministry %}
          <a href="{% url 'ministry-detail' object.ministry.pk %}" class="rvo-link">{{ object.ministry.name }} ({{ object.ministry.abbreviation }})</a>
        {% else %}
          <span class="rvo-text--italic">Geen ministerie opgegeven</span>
        {% endif %}
      </dd>
      <dt>Status</dt>
      <dd>
        <span class="rvo-tag status-{{ object.status|lower }}">{{ object.status }}</span>
      </dd>
      <dt>Startdatum</dt>
      <dd>{{ object.start_date }}</dd>
      <dt>Einddatum</dt>
      <dd>{{ object.end_date }}</dd>
      <dt>Extra info</dt>
      <dd>{{ object.extra_info }}</dd>
      <dt>Acties</dt>
      <dd>
        <div class="rvo-layout-row rvo-layout-gap--sm">
          <a href="/assignments/{{ object.pk }}/update" class="utrecht-button utrecht-button--subtle utrecht-button--rvo-xs rvo-link--no-underline">
            Opdracht bewerken
          </a>
          <a href="/assignments/{{ object.pk }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-xs rvo-link--no-underline">
            Opdracht verwijderen
          </a>
        </div>
      </dd>
    </dl>

    <!-- Tab Navigation -->
    <div class="assignment-tabs-navigation">
      <ul
        class="rvo-tabs rvo-ul rvo-ul--no-margin rvo-ul--no-padding rvo-ul--icon rvo-ul--icon-option-2"
        role="tablist"
        aria-label="Assignment Detail Tabs"
      >
        {% for tab_key, tab_data in tab_groups.items %}
        <li role="presentation" class="rvo-tabs__item">
          <a
            href="?tab={{ tab_key }}"
            class="rvo-link rvo-tabs__item-link {% if active_tab == tab_key %}rvo-tabs__item-link--active rvo-link--active{% endif %} rvo-link--no-underline"
            role="tab"
            aria-selected="{% if active_tab == tab_key %}true{% else %}false{% endif %}"
          >
            {{ tab_data.title }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Tab Content -->
    {% if active_tab == 'services' %}
    <div id="tab-diensten" class="rvo-margin-block-end--md">

      {% for service in object.services.all %}
      <div class="rvo-card rvo-card--outline rvo-card--padding-lg rvo-layout-margin-bottom--lg rvo-card--full-colour--grijs-100" style="margin: 10px;">
        <!-- Service Header -->
        <div class="rvo-layout-row rvo-layout-gap--md rvo-layout-align--space-between rvo-layout-align--center rvo-layout-margin-bottom--lg">
          <h3 class="utrecht-heading-3">{{ service.description }}</h3>
        </div>

        <!-- Details Grid -->
        <div class="rvo-layout-grid rvo-layout-gap--lg rvo-layout-grid-columns--three rvo-layout-margin-bottom--lg">
            <!-- Search Criteria -->
            <div class="rvo-layout-column">
              <label class="rvo-label">Rol </label>
              <span class="rvo-tag">{% if service.skill %}{{ service.skill.name }}{% else %}-{% endif %}</span>
            </div>
            <div class="rvo-layout-column">
              <label class="rvo-label">Wanneer </label>
              <p class="utrecht-paragraph rvo-paragraph--no-margins">
                {{ service.start_date|date:"j M Y" }} - {{ service.end_date|date:"j M Y" }}
              </p>
            </div>
            <div class="rvo-layout-column">
              <label class="rvo-label">Acties </label>
              <div class="rvo-layout-row rvo-layout-gap--sm">
                <a href="/services/{{ service.id }}/update" class="utrecht-button utrecht-button--subtle utrecht-button--rvo-xs rvo-link--no-underline">
                  Dienst bewerken
                </a>
                <a href="/services/{{ service.id }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-xs rvo-link--no-underline">
                  Dienst verwijderen
                </a>
              </div>
            </div>
        </div>
        
        {% if service.placements.all %}
        <div class="rvo-layout-margin-bottom--md">
            <h4 class="utrecht-heading-4 rvo-layout-margin-bottom--md">Personen:</h4>

              <!-- Show assigned people -->
            {% for placement in service.placements.all %}
            <div class="rvo-card rvo-card--outline rvo-card--padding-sm rvo-layout-margin-bottom--md rvo-card--full-colour--wit">
              <div class="rvo-layout-grid rvo-layout-gap--md rvo-layout-grid-columns--four">
                <div class="rvo-layout-column">
                 <label class="rvo-label">Naam </label>
                  {% if placement.colleague %}
                    <a href="{% url 'colleague-detail' placement.colleague.pk %}" class="rvo-link">{{ placement.colleague.name }}</a>
                  {% else %}
                    <span class="rvo-text--italic">TBD</span>
                  {% endif %}
                </div>
                <div class="rvo-layout-column">
                  <label class="rvo-label">Periode</label>
                  <span>{{ placement.start_date|date:"j M Y" }} - {{ placement.end_date|date:"j M Y" }}</span>
                </div>
                <div class="rvo-layout-column">
                  <label class="rvo-label">Inzet </label>
                  <span>{% if placement.hours_per_week %}{{ placement.hours_per_week }} u/week{% else %}-{% endif %} </span>
                </div>
                <div class="rvo-layout-column">
                  <label class="rvo-label">Acties </label>
                  <div class="rvo-layout-row rvo-layout-gap--sm">
                    <a href="/placements/{{ placement.id }}/update" class="utrecht-button utrecht-button--subtle utrecht-button--rvo-xs rvo-link--no-underline">
                      Bewerken
                    </a>
                    <a href="/placements/{{ placement.id }}/delete" class="utrecht-button utrecht-button--subtle utrecht-button--warning utrecht-button--rvo-xs rvo-link--no-underline">
                      Verwijderen
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}

        </div>
        {% endif %}
        
          <div style="margin-top: 10px;">
            <a href="/services/{{ service.id }}/placements/new" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-sm rvo-link--no-underline">
              Voeg persoon toe
            </a>
            <a href="/colleagues/?status=beschikbaar{% if service.skill %}&skill={{ service.skill.id }}{% endif %}" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-sm rvo-link--no-underline">
              Bekijk matches
            </a>
          </div>
  
      </div>
      {% empty %}
      <div class="rvo-card rvo-card--outline rvo-card--padding-lg">
        <p class="utrecht-paragraph rvo-paragraph--no-margins rvo-text--subtle">
          Nog geen diensten gedefinieerd voor deze opdracht.
        </p>
      </div>
      {% endfor %}

      <div class="rvo-layout-margin-top--xl">
        <div class="rvo-card rvo-card--outline rvo-card--padding-lg rvo-layout-margin-bottom--lg rvo-card--full-colour--grijs-100" style="margin: 10px;">
          <div class="rvo-card__content">
            <a class="rvo-link rvo-link--with-icon rvo-link--no-underline rvo-link--donkerblauw" href="/assignments/{{ object.pk }}/services/new">
              <span class="utrecht-icon rvo-icon rvo-icon-plus rvo-icon--sm rvo-icon--donkerblauw rvo-link__icon--before" role="img" aria-label="Plus"></span>
              Dienst toevoegen
            </a>
          </div>
        </div>
      </div>
    
    </div>
    {% endif %}

    {% if active_tab == 'notes' %}
    <div id="tab-notities">
      <h2 class="utrecht-heading-2 rvo-heading--no-margins">Notities</h2>

    {% if notes %}
      <div class="rvo-layout-column rvo-layout-gap--md">
        {% for note in notes %}
          <div class="rvo-card rvo-card--outline rvo-card--padding-md">
            <div class="rvo-card__content">
              <div class="rvo-layout-row rvo-layout-gap--sm">
                <strong>{{ note.colleague.name }}</strong>
                <span class="rvo-text--subtle">{{ note.created_at|date:"d-m-Y H:i" }}</span>
              </div>
              <p class="rvo-paragraph">{{ note.message }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="rvo-text--italic">Nog geen notities toegevoegd.</p>
    {% endif %}

    <div class="rvo-layout-row rvo-layout-gap--md">
      <button type="button" class="utrecht-button utrecht-button--secondary-action utrecht-button--rvo-md" onclick="toggleNoteForm()">
        Notitie toevoegen
      </button>
    </div>

    <!-- Note form (initially hidden) -->
    <div id="note-form" class="rvo-layout-column rvo-layout-gap--md" style="display: none; margin-top: 1rem;">
      <form method="post" action="{% url 'add-note' object.pk %}">
        {% csrf_token %}
        <div class="rvo-form-field">
          <label for="note-message" class="rvo-label">Notitie:</label>
          <textarea id="note-message" name="message" class="rvo-textarea" rows="4" placeholder="Voer uw notitie in..." required></textarea>
        </div>
        <div class="rvo-layout-row rvo-layout-gap--sm">
          <button type="submit" class="utrecht-button utrecht-button--primary-action utrecht-button--rvo-sm">
            Notitie opslaan
          </button>
          <button type="button" class="utrecht-button utrecht-button--subtle utrecht-button--rvo-sm" onclick="toggleNoteForm()">
            Annuleren
          </button>
        </div>
      </form>
    </div>

    <script>
      function toggleNoteForm() {
        const form = document.getElementById('note-form');
        const isHidden = form.style.display === 'none';
        form.style.display = isHidden ? 'block' : 'none';
        
        if (isHidden) {
          // Clear the form when showing
          document.getElementById('note-message').value = '';
        }
      }
    </script>
    </div>
    {% endif %}

  </div>
</div>
{% endblock content %}